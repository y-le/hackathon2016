<!DOCTYPE html>
<html>
<head>
<!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/simple-sidebar.css" rel="stylesheet">
  <style>
    #map {
      height: 400px;
      width: 100%;
    }
  </style>
  <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
</head>
<body>
<div id="wrapper">
<h3>Analiza kosztu podłączenia miejscowości do łącza</h3>
<div id="sidebar-wrapper">
	<div id="coords"><label for="usr">Twoja lokalizacja:</label><br/>
        <label for="latLoc">Szerokość</label>
		<input type="number" class="form-control" id="latLoc" value="54.21145178746455"/>
        <label for="lenLoc">Długość</label>
        <input type="number" class="form-control" id="lenLoc" value="22.055740356445312"/>
		<button type="button" class="btn btn-default" id="localization-button">Szukaj</button>
	</div>
	<div class="panel panel-default">
	  <!-- Default panel contents -->
	  <div class="panel-heading" style="font-weight: bold; text-align: center">Pobliskie miejscowości</div>

	  <!-- Table -->
	  <table class="table" id="tabelaWiosek">
	  <tr><td>Nazwa miejscowości</td><td>Odległość [km]</td><td>Liczba mieszkańców</td></tr>
		
	  </table>
	</div>
</div>
<div id="map"></div>
<div class="panel panel-default">
	  <!-- Default panel contents -->
	  <div class="panel-heading" style="font-weight: bold; text-align: center">Dostępne przyłącza</div>

	  <!-- Table -->
	  <table class="table" id="tabelaNodow" >
	  <tr><td>Nazwa właściciela</td><td>Odległość od miejscowości</td><td>Szybkość łącza</td></tr>
	  </table>
	</div>



</div>

<script>

  var map;
  var myLocationMarker = undefined;
  var markers = [];
  var communicationNodes = [{lat: 52.2, lng: 21.1}, {lat: 52.15, lng: 21.2}];
  var villages = [{name: "Abc", dystansDoNas: 0, liczbaMieszkancow: 200, obszar: 2.23, lat: 54.21145178746455, lng: 22.055740356445312}];
  var radius = 10;
  var wlasciciele = ['Orion', 'JakuBas', 'TaniInternet', 'Wlaczek'];
  var lacza = [ 'światłowód', 'miedź'];
  var wioska;

  var iconPathBase = "img/";
  var icons = {
      radiotower: {
        icon: iconPathBase + 'radiotower.png'},
	  village: {
	    icon: iconPathBase + 'house.png' }
    };

  function getInitialCoords() {
    return {lat: 54.21145178746455, lng: 22.055740356445312};
  }

  var i = 0;
  var jumped1;
  var jumped2;
  var rowId = 0;
  function addRow(village){
	$("#tabelaWiosek").append('<tr id=\"' + rowId + '\"' + '><td>' + village.glowna + '</td><td>' + getDistanceFromLatLonInKm(village.lat, village.lng, myLocationMarker.getPosition().lat(), myLocationMarker.getPosition().lng()).toFixed(1) + '</td><td>' + Math.floor(village.populacja / ((Math.random() * 10) % 12 + 4)) + '</td></input><td style=\"display:none\">' + parseFloat(village.lat) + '</td><td style=\"display:none\">' + parseFloat(village.lng) + '</td></tr>');
	$("#" + rowId ).click(function() { villageClicked(this); });
	var colorCopy = $("#" + rowId).css('backgroundColor');
	//TODO: zmienic na ladny kolor 
	$("#" + rowId).mouseenter(function() {
		$(this).css({background:'lightblue'}); 
		var x = new google.maps.Marker({
		  position: {lat:village.lat, lng:village.lng},
		  map: map,
		  icon: icons.village.icon,
		  animation: google.maps.Animation.DROP
		});
		jumped1 = x;
		});
	$("#" + rowId).mouseleave(function() {
		$(this).css({background:colorCopy});
		jumped1.setMap(null);
		});
	rowId = rowId + 1;
  }
  
  function nodeClicked(node){
	window.location.replace("to_buy.html");
  }
  
  var rowId2 = 0;
  function addRow2(node){
	$("#tabelaNodow").append('<tr id=\"a' + rowId2 + '\"' + '><td>' + wlasciciele[Math.floor((Math.random() * 10)) % 4] + '</td><td>' + getDistanceFromLatLonInKm(wioska.lat, wioska.lng, node.lat, node.lng) + '</td><td>' + lacza[Math.floor((Math.random() * 10)) % 2] + '</td></input><td style=\"display:none\">' + node.lat + '</td><td style=\"display:none\">' + node.lng + '</td></tr>');
	$("#a" + rowId2 ).click(function() { nodeClicked(this); });
	var colorCopy = $("#a" + rowId2).css('backgroundColor');
	//TODO: zmienic na ladny kolor 
	$("#a" + rowId2).mouseenter(function() {
		$(this).css({background:'lightblue'});
		var x2 = new google.maps.Marker({
		  position: {lat:node.lat, lng:node.lng},
		  map: map,
		  icon: icons.radiotower.icon,
		  animation: google.maps.Animation.DROP
		});
		jumped2 = x2;
		});
	$("#a" + rowId2).mouseleave(function() {
	$(this).css({background:colorCopy});
		jumped2.setMap(null);});
	rowId2 = rowId2 + 1;
  }
	
  function villageClicked(row) {
	clearMarkers();
	$("#tabelaNodow").html("<tr><td>Nazwa właściciela</td><td>Odległość od miejscowości</td><td>Szybkość łącza</td></tr>");
	listOfChildren = $(row).children();
	len = listOfChildren.length;
	
	vilCoords = {lat: parseFloat($(listOfChildren[len - 2]).html()),
				lng: parseFloat($(listOfChildren[len - 1]).html())};
	wioska = vilCoords;
				
	setMarker(vilCoords, icons.village.icon);
	
	var closestNodes = getListOfclosestNodes(communicationNodes, vilCoords, radius);
	closestNodes.sort(function(a, b){ getDistanceFromLatLonInKm(a.lat, a.lng, vilCoords.lat, vilCoords.lng) <
										getDistanceFromLatLonInKm(b.lat, b.lng, vilCoords.lat, vilCoords.lng)});
										
	range = 5;
	if (range > closestNodes.length){
		range = closestNodes.length;
	}
	
	
	sliced = closestNodes.slice(0, range);
	
	// dodac dobre baze nodow
	for (var i = 0; i < sliced.length; ++i){
		addRow2({name:'nazwa', dystansDoNas:123, szybkosc:321, lat:sliced[i].lat, lng:sliced[i].lng});
	}
	setMarkers(sliced, icons.radiotower.icon);
    sliced.push(vilCoords);
	sliced.push({lat:myLocationMarker.getPosition().lat(), lng:myLocationMarker.getPosition().lng() });
    fitBounds(sliced);
  }
  
  function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
      zoom: 6,
      center: getInitialCoords()
    });
	
	//console.log(communicationNodes.length);
	$.getJSON("points.json", function(json) {	
	console.log("jestem");
    communicationNodes = json; // this will show the info it in firebug console
	console.log(communicationNodes.length);
	
	//$(".rowek").click(function() { console.log("asd");});
});
	

	
	//console.log(communicationNodes.length);
	$.getJSON("wynik.json", function(json) {	
	console.log("jestem2");
    villages = json; // this will show the info it in firebug console
	villages2 = []
	for (var i = 0; i < villages.length; ++i){
	 villages2.push({populacja: parseInt(villages[i].populacja),
		glowna: villages[i].glowna, 
		lat: parseFloat(villages[i].lat),
		lng: parseFloat(villages[i].lng)});
	}
	villages = villages2;
	console.log(villages.length);
	
	//$(".rowek").click(function() { console.log("asd");});
});
	
	
	setupListeners();
  }

  function setMarker(coords, icon){
    //alert(coords.lat + " " + coords.lng);
    var marker = new google.maps.Marker({
      position: coords,
      map: map,
      icon: icon
    });

    markers.push(marker);

    return marker;
  }

  function setMarkers(listOfCoords, icon){
    for (var i = 0; i < listOfCoords.length; i++) {
        setMarker(listOfCoords[i], icon);
    }
  }

  function clearMarkers(){
    for (var i = 0; i < markers.length; i++){
        if (markers[i] !== myLocationMarker){
            markers[i].setMap(null);
        }
    }
  }

  function setMyLocation(coords){
    if (myLocationMarker !== undefined){
        myLocationMarker.setMap(null);
    }
    //alert(coords.lat);
    myLocationMarker = setMarker(coords);
    
    updateView(coords);
  }
  
  /*var closestNodes = getListOfclosestNodes(communicationNodes, coords, radius);
	
    setMarkers(closestNodes, icons.radiotower.icon);
    closestNodes.push(coords);
    fitBounds(closestNodes);*/

  function updateView(coords){
   
    clearMarkers();
    map.setCenter(coords);

    var closestVillages = getListOfclosestNodes(villages, coords, radius);
	$("#tabelaWiosek").html("<tr><td>Nazwa miejscowości</td><td>Odległość</td><td>Liczba mieszkańców</td></tr>");
	for (var i = 0; i < closestVillages.length; ++i){
		addRow(closestVillages[i]);
	}
    setMarkers(closestVillages, icons.village.icon);
    closestVillages.push(coords);
    fitBounds(closestVillages);

	

    $("#latLoc").val(coords.lat);
    $("#lenLoc").val(coords.lng);

  }

  function fitBounds(coordsList){
    var bounds = new google.maps.LatLngBounds();

    for (var i = 0; i < coordsList.length; i++) {
        bounds.extend(coordsList[i]);
    }
    map.fitBounds(bounds);
  }

  function setupListeners(){
    //MapMouseClick
    map.addListener('click', function(event) {
      setMyLocation({ lat: event.latLng.lat(), lng: event.latLng.lng() });
    });

    //SubmitLocationClicked
    $("#localization-button").click(function(){
        var coords = {lat: parseFloat($("#latLoc").val()), lng: parseFloat($("#lenLoc").val())};
        setMyLocation(coords);
    });
	
  } 

	function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
      var R = 6371; // Radius of the earth in km
      var dLat = deg2rad(lat2-lat1);  // deg2rad below
      var dLon = deg2rad(lon2-lon1); 
      var a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
        Math.sin(dLon/2) * Math.sin(dLon/2)
        ; 
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
      var d = R * c; // Distance in km
      //alert(d);
      return d;
    }

    function deg2rad(deg) {
      return deg * (Math.PI/180);
    }

    function getListOfclosestNodes(list, coords, length) {
      var result = [];

      for (i = 0; i < list.length; i++) {
        if (getDistanceFromLatLonInKm(list[i].lat, list[i].lng, coords.lat, coords.lng) <= length) {
          result.push(list[i]);
        }
      }

      return result;
    }

</script>
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBwbsD_1fcone450PTkpMAy_u40_CVcGms&callback=initMap">
</script>
</body>
</html>
