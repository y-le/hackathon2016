<!DOCTYPE html>
<html>
<head>
<!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/simple-sidebar.css" rel="stylesheet">
  <style>
    #map {
      height: 400px;
      width: 100%;
    }
  </style>
  <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
</head>
<body>
<div class="container">
	<h3>Dla klienta...</h3>
	<div class="row">
		<div class="col-md-4">
			<form id="form1">
			  Imie:<br>
			  <input type="text" id="Imie"><br>
			  Nazwisko:<br>
			  <input type="text" id="Nazwisko"><br>
			  Email:<br>
			  <input type="text" id="Email"><br>
			  Telefon:<br>
			  <input type="text" id="Telefon"><br>
			  Uwagi:<br>
			  <input type="text" id="Uwagi" id="asd" placeholder="First Name:"><br>
			</form> 
			<button value="Submit" onclick="doIt()">Submit</button>
		</div>
		<div class="col-md-8">
			<div id="map"></div>
		</div>
	</div>
</div>

<script>

  var iconPathBase = "img/";
  var icons = {
      radiotower: {
        icon: iconPathBase + 'radiotower.png'},
	  questionMark: {
	    icon: iconPathBase + 'questionMark.png' }
    };

var markers;
var radius = 10;
var maxSkargi = 100;
 var map;
  var myLocationMarker = undefined;
  var communicationNodes = [{lat: 52.2, lng: 21.1}, {lat: 52.15, lng: 21.2}];
	var addresses = ["MAŁOPOLSKIE nowotarski Rabka-Zdrój (gmina miejsko-wiejska) Rabka-Zdrój 1", 
					"WIELKOPOLSKIE wolsztyński Siedlec Wąchabno 1"];

  var iconPathBase = "img/";
  var icons = {
      radiotower: {
        icon: iconPathBase + 'radiotower.png'}
    };

function doIt() {
	var name = document.getElementById("Imie").value;	
	var surname = document.getElementById("Nazwisko").value;
	var email = document.getElementById("Email").value;
	var phone = document.getElementById("Telefon").value;
	var observations = document.getElementById("Uwagi").value;
	var lat = myLocationMarker.getPosition().lat();
	var lng = myLocationMarker.getPosition().lng();
	
}

  function getInitialCoords() {
    return {lat: 52.14, lng: 21.1};
  }
  
  var skargi = undefined;

  function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
      zoom: 6,
      center: getInitialCoords()
    });
    setupListeners();
    setMyLocation(getInitialCoords());
    
    $.getJSON("skargi.json", function(json) {	
    	skargi = json; // this will show the info it in firebug console
	});
	
	var closestNodes = getListOfclosestNodes(communicationNodes, vilCoords, radius);
	
  }

  function setMarker(coords, icon){
    marker = new google.maps.Marker({
      position: coords,
      map: map,
      icon: icon
    });
    return marker;
  }
  
  function clearMarkers(){
    for (var i = 0; i < markers.length; i++){
        if (markers[i] !== myLocationMarker){
            markers[i].setMap(null);
        }
    }
  }

	function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
      var R = 6371; // Radius of the earth in km
      var dLat = deg2rad(lat2-lat1);  // deg2rad below
      var dLon = deg2rad(lon2-lon1); 
      var a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
        Math.sin(dLon/2) * Math.sin(dLon/2)
        ; 
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
      var d = R * c; // Distance in km
      //alert(d);
      return d;
    }

    function deg2rad(deg) {
      return deg * (Math.PI/180);
    }

    function getListOfclosestNodes(coords, length) {
      var result = [];

      for (i = 0; i < skargi.length; i++) {
        if (getDistanceFromLatLonInKm(skargi[i].lat, skargi[i].lng, coords.lat, coords.lng) <= length) {
          result.push(skargi[i]);
        }
      }

      return result;
    }

  
  function setMyLocation(coords){
    if (myLocationMarker !== undefined){
        myLocationMarker.setMap(null);
    }

    myLocationMarker = setMarker(coords);
    
    updateView(coords);
  }

	function getCoordsByAddress(address, callback) {
		var geocoder = new google.maps.Geocoder();
		geocoder.geocode( { 'address': address}, function(results, status) {
	      if (status == 'OK') {
	        callback(results[0].geometry.location);
	      } else {
	      	alert(":(");
	      }
	    });
	}

  function setupListeners(){
    //MapMouseClick
    map.addListener('click', function(event) {
      setMyLocation(event.latLng);
		placeMarker(event.latLng);
	  	clearMarkers();
	  	
	  	setMarkers(getListOfclosestNodes(myLocationMarker, radius), icons.questionMark.icon);
    });

    //SubmitLocationClicked
    $("#localization-button").click(function(){
        var coords = {lat: parseFloat($("#latLoc").val()), lng: parseFloat($("#lenLoc").val())};
        setMyLocation(coords);
    });
  } 

	google.maps.event.addListener(map, 'click', function(event) {
	  	placeMarker(event.latLng);
	  	clearMarkers();
	  	
	  	setMarkers(getListOfclosestNodes(myLocationMarker, radius), icons.questionMark.icon);
	});
	
	  function setMarkers(listOfCoords, icon){
	    for (var i = 0; i < listOfCoords.length; i++) {
	        setMarker(listOfCoords[i], icon);
	    }
	  }


	function placeMarker(location) {
		if (myLocationMarker !== undefined) {
			myLocationMarker.setMap(null);
		}
		
	    myLocationMarker = new google.maps.Marker({
	        position: location, 
	        map: map
	    });
	}
	
</script>
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBwbsD_1fcone450PTkpMAy_u40_CVcGms&callback=initMap">
</script>
</body>
</html>
